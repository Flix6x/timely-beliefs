name: Notify Agent on Failure
on:
  workflow_run:
    workflows: ["lint-and-test"]
    types: [completed]

permissions:
  contents: read
  issues: write
  pull-requests: write

jobs:
  notify-pr:
    if: ${{ github.event.workflow_run.conclusion == 'failure' }}
    runs-on: ubuntu-latest
    steps:
      - name: Comment on PR with auto-fix request
        uses: actions/github-script@v6
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const run = context.payload.workflow_run;
            
            // Find the PR associated with this workflow run
            const pulls = await github.rest.pulls.list({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              head: `${context.repo.owner}:${run.head_branch}`
            });
            
            if (pulls.data.length === 0) {
              console.log(`No open PR found for branch ${run.head_branch}`);
              return;
            }
            
            const pr = pulls.data[0];
            const body = [
              `@copilot The test suite failed on this PR. Please analyze and fix the failing tests.`,
              "",
              `**Failure Details:**`,
              `- Branch: ${run.head_branch}`,
              `- SHA: ${run.head_sha}`,
              `- Workflow: ${run.name}`,
              `- Workflow run: ${run.html_url}`,
              "",
              "Please review the test failures, fix them, and ensure all tests pass before this PR is ready for review.",
              "",
              "_This is an automated message. The agent will create conservative fixes as draft commits only, never auto-merge._"
            ].join("\n");
            
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: pr.number,
              body
            });
